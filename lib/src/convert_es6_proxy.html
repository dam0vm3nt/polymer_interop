<!--
Copyright (c) 2015, the Dart project authors.  Please see the AUTHORS file
for details. All rights reserved. Use of this source code is governed by a
BSD-style license that can be found in the LICENSE file.
-->
<link rel="import" href="convert.html">
<script>
  Polymer.PolymerInterop = Polymer.PolymerInterop || {};
  Polymer.PolymerInterop.ES6 = Polymer.PolymerInterop.ES6 || {};

  (function(ES6) {

    ES6.Unsupported = {};

    var isADartMethod = function() {
      throw new Error("This method should be overridden by dart implementation");
    };

    // Patch array concat (concat between with a proxy is not working )
    // see https://github.com/tvcutsem/harmony-reflect/issues/13 for example
    // called from `_initES6ListProxySupport`
    ES6._patchArrayConcat = function() {
      var _origConcat = Array.prototype.concat;
      Array.prototype.concat = function(/*...args*/) {
      var length;
      for (var i = 0; i < arguments.length; i++) {
           if (Array.isArray(arguments[i])) {
             length = arguments[i].length;
             arguments[i] = arguments[i].slice();
           }
         }
         return _origConcat.apply(this, arguments);
      };
    }


    ES6._dartArrayGet = isADartMethod;
    ES6._dartArrayPut = isADartMethod;
    ES6._dartArraySplice = isADartMethod;
    ES6._dartArraySlice = isADartMethod;
    ES6._dartArrayLength = isADartMethod;
    ES6._dartArrayPush = isADartMethod;

    ES6._dartGet = isADartMethod;
    ES6._dartPut = isADartMethod;
    ES6._dartKeys = isADartMethod;

    /**
     * List ES6JsProxy support
     */

    var arrayCommonBehaviors = {
      '__dartClass__' : function(instance) { return instance; },
      '__isES6Proxy__' : function(instance) { return true; },
      'splice' : function (instance) {
        return function(index,howmany) {
          return ES6._dartArraySplice(instance,index,howmany,Array.prototype.slice.call(arguments,2));
        };
      },
      'slice' : function(instance) {
        return function(begin,end) {
          return ES6._dartArraySlice(instance,begin,end);
        };
      },
      'length' : function(instance) { return ES6._dartArrayLength(instance); },
      'push' : function(instance) {
        return function() {
          return ES6._dartArrayPush(instance,Array.prototype.slice.call(arguments));
        };
      },
      'forEach' : function(instance) {
        return function(callback, thisArg) {
          var len = ES6._dartArrayLength(instance);
          for (var i = 0 ;i < len;i++) {
            callback.call(thisArg,ES6._dartArrayGet(instance,i),i,this);
          }
        }
      }
    };

    ES6.createES6JsProxyForArray = function(instance) {
      return new Proxy([],{
        'get' : function(target,propertyName,proxy) {

          if (arrayCommonBehaviors.hasOwnProperty(propertyName)) {
            return arrayCommonBehaviors[propertyName].call(this,instance);
          }

          if (isNaN(propertyName.toString())) {
            return target[propertyName];
          }

          return ES6._dartArrayGet(instance,+propertyName);
        },

        getOwnPropertyDescriptor: function(target, prop) {
          var len = ES6._dartArrayLength(instance);
          var pos = +prop;
          if (!isNaN(prop) && pos>=0 && pos < len ) {
            return { configurable: true, enumerable: true, value: ES6._dartArrayGet(instance,pos) };
          }
          return Object.getOwnPropertyDescriptor(target,prop);
        },

        'set' : function(target,propertyName,value,proxy) {
          if (isNaN(propertyName.toString())) {
            target[propertyName] = value;
          } else {
            ES6._dartArrayPut(instance,+propertyName,value);
          }
          return true;
        },
        'ownKeys' : function(target) {
          var x = Object.getOwnPropertyNames(target).slice();
          for (var i = 0 ;i<ES6._dartArrayLength(instance);i++) {
            x.push(""+i);
          }
          return x;
        }
      });
    };


    /**
     * Maps ES6JsProxy support
     */

    var mapCommonBehaviors = {
      '__dartClass__' : function(instance) { return instance; },
      '__isES6Proxy__' : function(instance) { return true; }
    };

    ES6.createES6JsProxyForMaps = function(instance) {
      return new Proxy({},{
        'has' : function(target,prop){
          return ES6._dartKeys(instance).indexOf(prop) >= 0;
        },
        getOwnPropertyDescriptor: function(target, prop) {
          if (ES6._dartKeys(instance).indexOf(prop) >= 0) {
            return { configurable: true, enumerable: true, value: ES6._dartGet(instance,prop) };
          }
          return Object.getOwnPropertyDescriptor(target,prop);
        },

        'get' : function(target,propertyName,proxy) {

          // target first! (because of '__proto__' , 'constructor' , and dart interop internals ... )
          var _cache = target[propertyName];
          if(_cache) {
            return _cache;
          }

          if (mapCommonBehaviors.hasOwnProperty(propertyName)) {
            return mapCommonBehaviors[propertyName].call(this,instance);
          }

          return ES6._dartGet(instance,propertyName);
        },

        'set' : function(target,propertyName,value,proxy) {
          ES6._dartPut(instance,propertyName,value);
          return true;
        },

        'ownKeys' : function(target) {
          return Object.getOwnPropertyNames(target).concat(ES6._dartKeys(instance));
        }
      });
    };

  })(Polymer.PolymerInterop.ES6);
</script>
