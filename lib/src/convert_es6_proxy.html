<!--
Copyright (c) 2015, the Dart project authors.  Please see the AUTHORS file
for details. All rights reserved. Use of this source code is governed by a
BSD-style license that can be found in the LICENSE file.
-->
<link rel="import" href="convert.html">
<script>
  Polymer.PolymerInterop = Polymer.PolymerInterop || {};
  Polymer.PolymerInterop.ES6 = Polymer.PolymerInterop.ES6 || {};

  (function(ES6) {

    ES6.Unsupported = {};

    var isADartMethod = function() {
      throw new Error("This method should be overridden by dart implementation");
    };

    // Patch array concat (concat between with a proxy is not working )
    // see https://github.com/tvcutsem/harmony-reflect/issues/13

    var _origConcat = Array.prototype.concat;
    Array.prototype.concat = function(/*...args*/) {
    var length;
    for (var i = 0; i < arguments.length; i++) {
         if (Array.isArray(arguments[i])) {
           length = arguments[i].length;
           arguments[i] = arguments[i].slice();
         }
       }
       return _origConcat.apply(this, arguments);
    };



    ES6._dartArrayGet = isADartMethod;
    ES6._dartArrayPut = isADartMethod;
    ES6._dartArraySplice = isADartMethod;
    ES6._dartArraySlice = isADartMethod;
    ES6._dartArrayLength = isADartMethod;
    ES6._dartArrayPush = isADartMethod;

    ES6._dartGet = isADartMethod;
    ES6._dartPut = isADartMethod;
    ES6._dartKeys = isADartMethod;

    /**
     * List ES6JsProxy support
     */

    var arrayCommonBehaviors = {
      '__dartClass__' : function(instance) { return instance; },
      '__isES6Proxy__' : function(instance) { return true; },
      'splice' : function (instance) {
        return function(index,howmany) {
          return ES6._dartArraySplice(instance,index,howmany,Array.prototype.slice.call(arguments,2));
        };
      },
      'slice' : function(instance) {
        return function(begin,end) {
          return ES6._dartArraySlice(instance,begin,end);
        };
      },
      'length' : function(instance) { return ES6._dartArrayLength(instance); },
      'push' : function(instance) {
        return function() {
          return ES6._dartArrayPush(instance,Array.prototype.slice.call(arguments));
        };
      }
    };

    ES6.createES6JsProxyForArray = function(instance) {
      var _extra = {};
      return new Proxy([],{
        'get' : function(target,propertyName,proxy) {

          if (arrayCommonBehaviors.hasOwnProperty(propertyName)) {
            return arrayCommonBehaviors[propertyName](instance);
          }

          if (propertyName == Symbol.isConcatSpreadable) {
            return true;
          }

          if (propertyName == '__proto__') {
            console.log("ARRAY PROTO : "+Array.prototype);
            console.log("OR "+target.__proto__);
            return Array.prototype;
          }

          if (isNaN(propertyName.toString())) {
            var x =  target[propertyName];
            console.log("ARR "+propertyName.toString()+" => " + x);
            return x;
          }

          console.log("ARR GETTING "+(propertyName.toString()));

          return ES6._dartArrayGet(instance,+propertyName);
        },

        'set' : function(target,propertyName,value,proxy) {
          if (isNaN(propertyName.toString())) {
            target[propertyName] = value;
          } else {
            ES6._dartArrayPut(instance,+propertyName,value);
          }
          return true;
        },

        'defineProperty' : function(target,prop,descr) {
          Object.defineProperty(target,prop,descr);
          _extra[prop]=true;
          console.log("ARR DEF "+prop+" :" +Object.keys(_extra));
          return true;
        },

        'ownKeys' : function(target) {
          var keys = {};
          for (var i = 0 ; i < ES6._dartArrayLength(instance) ; i++) {
            keys[""+i]=true;
          }
          for (var k in _extra) {
            keys[k] = true;
          }
          for (var k in target) {
            keys[k] = true;
          }
          keys['length'] = true;
          keys = Object.keys(keys);
          console.log("ARRAY OWN KEYS : "+keys);
          console.log("ARRAY EXTRA "+Object.keys(_extra));
          keys.push("___dart__$dart_dartObject_ZxYxX_0_");
          return keys;
        }
      });
    };


    /**
     * Maps ES6JsProxy support
     */

    var mapCommonBehaviors = {
      '__dartClass__' : function(instance) { return instance; },
      '__isES6Proxy__' : function(instance) { return true; }
    };

    ES6.createES6JsProxyForMaps = function(instance) {
      var _extra = {};
      return new Proxy({},{
        'get' : function(target,propertyName,proxy) {

          // target first! (because of '__proto__' , 'constructor' , and dart interop internals ... )
          var _cache = target[propertyName];
          if(_cache) {
            return _cache;
          }

          if (mapCommonBehaviors.hasOwnProperty(propertyName)) {
            return mapCommonBehaviors[propertyName](instance);
          }

          return ES6._dartGet(instance,propertyName);
        },

        'set' : function(target,propertyName,value,proxy) {
          ES6._dartPut(instance,propertyName,value);
          return true;
        },

        'defineProperty' : function(target,prop,descr) {
          Object.defineProperty(target,prop,descr);
          _extra[prop]=true;
          return true;
        },

        'ownKeys' : function(target) {
          var keys = ES6._dartKeys(instance).concat(Object.getOwnPropertyNames(target),Object.keys(_extra));
          console.log("MAP OWN KEYS: "+keys);
          return keys;
        }
      });
    };

  })(Polymer.PolymerInterop.ES6);
</script>
